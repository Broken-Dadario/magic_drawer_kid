<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Words - é­”æ³•å•è¯æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+SC:wght@400;700&family=Schoolbell&display=swap" rel="stylesheet">
    <style>
        /* çº¸å¼ çº¹ç†èƒŒæ™¯ */
        body {
            font-family: 'Schoolbell', 'Noto Sans SC', cursive;
            background-color: #fdfbf7;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: #4a4a4a;
            /* ç§»é™¤ touch-action å’Œ overflow é™åˆ¶ï¼Œå…è®¸é¡µé¢æ»šåŠ¨ */
            min-height: 100vh;
            min-height: 100dvh;
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* æ‰‹ç»˜é£æ ¼æ–¹æ¡† */
        .sketchy-box {
            background: white;
            border: 3px solid #4a4a4a;
            border-radius: 2px 255px 3px 25px / 255px 5px 225px 3px;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
        }

        /* æ‰‹ç»˜é£æ ¼æŒ‰é’® */
        .sketchy-btn {
            border: 2px solid #4a4a4a;
            background-color: white;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 3px 3px 0px 0px rgba(0,0,0,0.8);
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        .sketchy-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px 0px rgba(0,0,0,0.8);
        }
        .sketchy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.1);
            background-color: #e5e7eb;
            color: #9ca3af;
        }

        /* å·¥å…·æŒ‰é’®æ ·å¼ */
        .tool-btn {
            transition: transform 0.2s;
            border: 2px solid #4a4a4a;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-btn.active {
            transform: scale(1.2) rotate(-5deg);
            border: 3px solid #000;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* èƒ¶å¸¦æ•ˆæœ */
        .paper-tape {
            background-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            backdrop-filter: blur(2px);
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* ç”»å¸ƒå®¹å™¨ - ç¡®ä¿å†…éƒ¨ä¸ä¼šæ»šåŠ¨ */
        #canvas-container {
            position: relative;
        }

        /* è‡ªå®šä¹‰å…‰æ ‡ */
        #drawing-board {
            cursor: crosshair;
            touch-action: none; /* åªåœ¨ç”»å¸ƒä¸Šç¦æ­¢è§¦æ‘¸æ»šåŠ¨ */
        }
        .cursor-pencil {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23000000" d="M7.127 22.562l-7.127 1.438 1.438-7.128 5.689 5.69zm1.414-1.414l11.228-11.225-5.69-5.692-11.227 11.227 5.689 5.69zm9.768-21.148l-2.816 2.817 5.691 5.691 2.816-2.819-5.691-5.689z"/></svg>') 0 24, crosshair !important;
        }
        .cursor-eraser {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20H7L3 16C2 15 2 13 3 12L13 2L22 11L20 20Z"/><path d="M17 17L7 7"/></svg>') 0 24, cell !important;
        }

        /* ç”»å¸ƒå®‰å…¨åŒºæç¤º */
        .safe-zone-hint {
            position: absolute;
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%);
            pointer-events: none;
            z-index: 5;
        }
        .safe-zone-hint.left { left: 0; top: 0; bottom: 0; width: 40px; }
        .safe-zone-hint.right { right: 0; top: 0; bottom: 0; width: 40px; background: linear-gradient(-90deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%); }
        .safe-zone-hint.top { left: 0; right: 0; top: 0; height: 40px; background: linear-gradient(180deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%); }
        .safe-zone-hint.bottom { left: 0; right: 0; bottom: 0; height: 40px; background: linear-gradient(0deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%); }

        /* ç§»åŠ¨ç«¯æ˜¾ç¤ºæ»šåŠ¨æç¤º */
        @media (max-width: 1023px) {
            .safe-zone-hint::before {
                content: 'ğŸ‘†';
                position: absolute;
                font-size: 12px;
                opacity: 0.5;
                animation: fadeInOut 2s infinite;
            }
            .safe-zone-hint.left::before { left: 10px; top: 50%; transform: translateY(-50%) rotate(-90deg); }
            .safe-zone-hint.right::before { right: 10px; top: 50%; transform: translateY(-50%) rotate(90deg); }
            .safe-zone-hint.top::before { left: 50%; top: 10px; transform: translateX(-50%); }
            .safe-zone-hint.bottom::before { left: 50%; bottom: 10px; transform: translateX(-50%) rotate(180deg); }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* åŠ è½½åŠ¨ç”» */
        .magic-loader {
            width: 48px;
            height: 48px;
            border: 5px solid #DDD;
            border-bottom-color: #8B5CF6;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            filter: url(#rough-paper); 
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å¤¸å¥–å¼¹çª—åŠ¨ç”» */
        @keyframes bounceIn {
            0% { transform: scale(0.1); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); }
        }
        .praise-modal {
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen w-full pb-20 sm:pb-32 lg:pb-40">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="w-full px-3 sm:px-6 py-2 sm:py-3 z-20 flex-none bg-[#fdfbf7] border-b-2 border-dashed border-slate-200">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 sm:gap-3 transform -rotate-1">
                <div class="text-2xl sm:text-3xl drop-shadow-sm">âœï¸</div>
                <div>
                    <h1 class="text-lg sm:text-2xl font-bold text-slate-800 tracking-wide sm:tracking-widest" style="text-shadow: 1px 1px 0px #e2e8f0;">é­”æ³•å•è¯æœ¬</h1>
                </div>
            </div>
            <div class="text-[10px] sm:text-xs font-bold bg-yellow-200 text-yellow-800 px-2 sm:px-3 py-1 border-2 border-yellow-800 rounded-full transform rotate-2 shadow-[2px_2px_0px_rgba(0,0,0,1)]">
                ç½‘é¡µç‰ˆæ¼”ç¤º
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-1 w-full max-w-7xl mx-auto p-3 sm:p-5 lg:p-6 flex flex-col lg:flex-row gap-4 sm:gap-5 lg:gap-6">

        <!-- å·¦ä¾§æ : æ§åˆ¶åŒº -->
        <aside class="flex-none w-full lg:w-80 flex flex-col gap-2 sm:gap-3 lg:gap-4 pb-2 sm:pb-4">

            <!-- å•è¯é€‰æ‹©å™¨ (ç°åœ¨æ”¯æŒåŠ¨æ€æ·»åŠ ) -->
            <div id="word-selector" class="grid grid-cols-3 lg:grid-cols-2 gap-2 sm:gap-3 transition-opacity duration-300">
                <button onclick="setWord('apple', true)" id="btn-apple" class="sketchy-btn py-2 sm:py-3 px-2 sm:px-4 bg-red-100 text-red-800 font-bold text-base sm:text-lg justify-start gap-2 sm:gap-3 active transform hover:-rotate-1 transition-all">
                    <span class="text-xl sm:text-2xl">ğŸ</span> <span class="hidden sm:inline">Apple</span><span class="sm:hidden">ğŸ</span>
                </button>
                <button onclick="setWord('tiger', true)" id="btn-tiger" class="sketchy-btn py-2 sm:py-3 px-2 sm:px-4 bg-orange-100 text-orange-800 font-bold text-base sm:text-lg justify-start gap-2 sm:gap-3 transform hover:rotate-1 transition-all">
                     <span class="text-xl sm:text-2xl">ğŸ¯</span> <span class="hidden sm:inline">Tiger</span><span class="sm:hidden">ğŸ¯</span>
                </button>
                <button onclick="setWord('ocean', true)" id="btn-ocean" class="sketchy-btn py-2 sm:py-3 px-2 sm:px-4 bg-blue-100 text-blue-800 font-bold text-base sm:text-lg justify-start gap-2 sm:gap-3 transform hover:-rotate-1 transition-all">
                     <span class="text-xl sm:text-2xl">ğŸŒŠ</span> <span class="hidden sm:inline">Ocean</span><span class="sm:hidden">ğŸŒŠ</span>
                </button>
                <!-- æ–°å¢ï¼šè‡ªå®šä¹‰æŒ‰é’® -->
                <button onclick="openCustomModal()" id="btn-custom-add" class="sketchy-btn py-2 sm:py-3 px-2 sm:px-4 bg-slate-100 text-slate-500 font-bold text-base sm:text-lg justify-center gap-2 transform hover:rotate-1 border-dashed border-4 border-slate-300">
                     <span class="text-xl sm:text-2xl">â•</span> <span class="hidden sm:inline">è‡ªå®šä¹‰</span>
                </button>
            </div>

            <!-- ä¿¡æ¯ä¸å·¥å…·å¡ç‰‡ -->
            <div class="sketchy-box p-3 sm:p-5 relative bg-white rotate-[0.5deg] flex-none">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-16 sm:w-24 h-4 sm:h-6 paper-tape z-20"></div>

                <div class="flex flex-col gap-1 relative">
                    <!-- Loading é®ç½©ç”¨äºå•è¯ç”Ÿæˆæ—¶ -->
                    <div id="word-loading" class="hidden absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center text-center rounded">
                        <div class="magic-loader w-8 h-8 mb-2"></div>
                        <p class="text-xs text-violet-500 font-bold">æ­£åœ¨åˆ¶ä½œå•è¯å¡...</p>
                    </div>

                    <div class="flex justify-between items-start">
                        <h2 id="display-word" class="text-2xl sm:text-3xl lg:text-4xl font-bold text-slate-800 tracking-wide break-words max-w-[70%]" style="text-shadow: 2px 2px 0px #eee;">Apple</h2>
                        <button onclick="speakCurrentWord()" class="sketchy-btn w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-violet-50 text-violet-600 shadow-sm transform hover:scale-105 text-sm sm:text-base flex-shrink-0" title="æœ—è¯»">ğŸ”Š</button>
                    </div>
                    <p id="display-meaning" class="text-base sm:text-lg lg:text-xl text-slate-500 font-bold font-noto">è‹¹æœ (pÃ­ng guÇ’)</p>
                </div>

                <!-- å·¥å…·æ  (ç”Ÿæˆåéšè—) -->
                <div id="tools-panel" class="mt-4 sm:mt-6 border-t-2 border-dashed border-slate-200 pt-3 sm:pt-4 transition-all duration-300">
                    <p class="text-[10px] sm:text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 sm:mb-3">ç”»ç¬”å·¥å…·</p>
                    <div class="flex justify-between gap-2 flex-wrap">
                        <button onclick="setColor('#2d2d2d')" class="tool-btn active w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-[#2d2d2d]" aria-label="é»‘è‰²"></button>
                        <button onclick="setColor('#ef4444')" class="tool-btn w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-[#ef4444]" aria-label="çº¢è‰²"></button>
                        <button onclick="setColor('#f97316')" class="tool-btn w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-[#f97316]" aria-label="æ©™è‰²"></button>
                        <button onclick="setColor('#3b82f6')" class="tool-btn w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-[#3b82f6]" aria-label="è“è‰²"></button>
                        <button onclick="setColor('#10b981')" class="tool-btn w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-[#10b981]" aria-label="ç»¿è‰²"></button>
                        <button onclick="setEraser()" id="btn-eraser" class="tool-btn w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-slate-100 text-lg sm:text-xl border-slate-300" title="æ©¡çš®æ“¦">ğŸ§½</button>
                    </div>
                    <div class="mt-3 sm:mt-4 flex justify-end">
                         <button onclick="clearCanvas()" class="text-xs sm:text-sm font-bold text-slate-400 hover:text-red-500 px-2 underline decoration-wavy decoration-slate-300 hover:decoration-red-300">
                            ğŸ—‘ï¸ æ¸…ç©ºç”»å¸ƒ
                        </button>
                    </div>
                </div>
                
                <!-- æˆåŠŸåæ˜¾ç¤ºçš„èµç¾è¯­ -->
                <div id="praise-text" class="hidden mt-6 text-center">
                    <p class="text-2xl font-bold text-violet-600 animate-pulse">âœ¨ å¤ªæ£’äº†ï¼ âœ¨</p>
                </div>
            </div>

            <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
            <div class="mt-auto pt-2">
                <!-- çŠ¶æ€1: ç”ŸæˆæŒ‰é’® -->
                <button id="btn-generate-magic" onclick="generateMagic()" class="sketchy-btn w-full py-3 sm:py-4 bg-gradient-to-r from-violet-400 to-fuchsia-400 text-white font-bold text-lg sm:text-xl gap-2 transform hover:-translate-y-1 shadow-[4px_4px_0px_rgba(0,0,0,1)] hover:shadow-[6px_6px_0px_rgba(0,0,0,1)] transition-all">
                    âœ¨ æ–½å±•é­”æ³•
                </button>

                <!-- çŠ¶æ€2: ç»“æœæ“ä½œæŒ‰é’® (é»˜è®¤éšè—) -->
                <div id="result-buttons" class="hidden flex flex-col gap-2 sm:gap-3">
                    <div class="flex gap-2 sm:gap-3">
                        <button onclick="saveImage()" class="sketchy-btn flex-1 py-2 sm:py-3 bg-violet-500 text-white font-bold text-sm sm:text-base hover:bg-violet-600 shadow-[3px_3px_0px_rgba(0,0,0,1)]">
                            ğŸ’¾ ä¿å­˜
                        </button>
                        <button onclick="resetApp()" class="sketchy-btn flex-1 py-2 sm:py-3 bg-white text-slate-700 font-bold text-sm sm:text-base hover:bg-slate-50">
                            ğŸ”„ å†ç”»
                        </button>
                    </div>
                </div>
            </div>

        </aside>

        <!-- å³ä¾§æ : å¤§ç”»æ¿ -->
        <section class="flex-1 relative h-[400px] sm:h-[500px] lg:h-[600px] xl:h-[700px] sketchy-box bg-white overflow-hidden border-2 sm:border-4 border-slate-700" id="canvas-container">

            <div class="absolute top-2 sm:top-4 left-2 sm:left-4 text-[10px] sm:text-sm text-slate-300 font-bold uppercase tracking-wider sm:tracking-widest select-none z-20 bg-white/80 px-1 sm:px-2 rounded" id="canvas-label">è‡ªç”±ç»˜ç”»åŒº</div>

            <!-- å®‰å…¨åŒºæç¤ºï¼ˆç§»åŠ¨ç«¯/å¹³æ¿æ˜¾ç¤ºï¼‰ -->
            <div class="safe-zone-hint left lg:hidden"></div>
            <div class="safe-zone-hint right lg:hidden"></div>
            <div class="safe-zone-hint top lg:hidden"></div>
            <div class="safe-zone-hint bottom lg:hidden"></div>

            <!-- 1. èƒŒæ™¯å±‚ -->
            <div id="canvas-bg" class="absolute inset-0 pointer-events-none flex flex-col justify-center h-full w-full opacity-40">
                <div class="h-1/2 w-full flex flex-col justify-center relative">
                     <div class="absolute w-full top-[10%] border-t border-t-2 sm:border-t-2 border-slate-300"></div>
                     <div class="absolute w-full top-[50%] border-t border-t-2 sm:border-t-2 border-dashed border-slate-300"></div>
                     <div class="absolute w-full top-[90%] border-t border-t-2 sm:border-t-2 border-red-200" style="border-color: #fca5a5;"></div>
                </div>
            </div>

            <!-- 2. ä¸´æ‘¹æ–‡å­— -->
            <div id="trace-layer" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                 <span id="trace-letters" class="font-[Schoolbell] text-[12vw] sm:text-[15vw] lg:text-[180px] xl:text-[200px] text-slate-100 select-none tracking-wider mt-[-2%]">apple</span>
            </div>

            <!-- 3. ç”»å¸ƒ (ç»˜ç”»ç”¨) -->
            <canvas id="drawing-board" class="relative z-10 block w-full h-full touch-none cursor-pencil"></canvas>
            
            <!-- 4. ç»“æœå±•ç¤ºå±‚ (ç”Ÿæˆå›¾ç‰‡ç”¨ï¼Œç›´æ¥è¦†ç›–åœ¨ç”»å¸ƒä¸Š) -->
            <img id="magic-result" class="hidden absolute inset-0 w-full h-full object-cover z-20" alt="é­”æ³•ç”»ä½œ">

            <!-- 5. åŠ è½½é®ç½© -->
            <div id="loading-overlay" class="hidden absolute inset-0 z-30 bg-white/90 flex flex-col items-center justify-center backdrop-blur-sm">
                <div class="magic-loader mb-4 sm:mb-6"></div>
                <p class="text-violet-600 font-bold text-base sm:text-xl animate-pulse">AI å°ç”»å®¶æ­£åœ¨æ–½æ³•...</p>
                <p class="text-slate-400 text-xs sm:text-sm mt-2">è¯·ç¨ç­‰ç‰‡åˆ»</p>
            </div>

            <!-- 6. å¤¸å¥–å¼¹çª— -->
            <div id="praise-modal" class="hidden absolute inset-0 z-40 flex items-center justify-center pointer-events-none p-4">
                <div class="praise-modal bg-white border-2 sm:border-4 border-yellow-400 rounded-2xl sm:rounded-3xl p-6 sm:p-8 shadow-[6px_6px_0px_rgba(0,0,0,0.2)] sm:shadow-[8px_8px_0px_rgba(0,0,0,0.2)] transform rotate-2 text-center max-w-sm">
                    <div class="text-4xl sm:text-6xl mb-3 sm:mb-4">ğŸŒŸ</div>
                    <h2 class="text-2xl sm:text-3xl font-bold text-violet-600 mb-2">å°æœ‹å‹ä½ çœŸæ£’ï¼</h2>
                    <p class="text-sm sm:text-base text-slate-500 font-bold">ç”»å¾—å¤ªå¥½çœ‹äº†ï¼</p>
                </div>
            </div>

            <!-- 7. æ–°å•è¯è¾“å…¥å¼¹çª— -->
            <div id="custom-word-modal" class="hidden absolute inset-0 z-50 bg-black/50 flex items-center justify-center backdrop-blur-sm p-4">
                <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl sketchy-box">
                    <h3 class="text-2xl font-bold text-slate-800 mb-4 text-center">âœ¨ æ·»åŠ æ–°å•è¯</h3>
                    <p class="text-sm text-slate-500 mb-2">è¾“å…¥ä½ æƒ³å­¦çš„è‹±è¯­å•è¯ï¼š</p>
                    <input type="text" id="new-word-input" class="w-full border-2 border-dashed border-slate-300 rounded-xl p-3 mb-4 text-xl text-center font-bold text-violet-600 outline-none focus:border-violet-500 bg-slate-50" placeholder="ä¾‹å¦‚: Banana">

                    <div class="flex justify-end gap-2">
                        <button onclick="closeCustomModal()" class="flex-1 py-3 rounded-xl text-slate-500 hover:bg-slate-100 font-bold">å–æ¶ˆ</button>
                        <button onclick="confirmCustomWord()" class="flex-1 py-3 rounded-xl bg-violet-500 text-white font-bold hover:bg-violet-600 shadow-md">ç¡®å®š</button>
                    </div>
                </div>
            </div>

        </section>

    </main>

    <script>
        // --- é…ç½®æ•°æ® ---
        const words = {
            apple: { text: "Apple", meaning: "è‹¹æœ (PÃ­ngguÇ’)", speak: "Apple, è‹¹æœ", color: "#ef4444", textCol: "text-red-800" },
            tiger: { text: "Tiger", meaning: "è€è™ (LÇohÇ”)", speak: "Tiger, è€è™", color: "#f97316", textCol: "text-orange-800" },
            ocean: { text: "Ocean", meaning: "æµ·æ´‹ (HÇiyÃ¡ng)", speak: "Ocean, æµ·æ´‹", color: "#3b82f6", textCol: "text-blue-800" }
        };
        
        let currentWordKey = "apple";
        let isDrawing = false;
        let brushColor = "#2d2d2d";
        let brushSize = 8; 
        let isEraser = false;
        let appMode = 'drawing'; // 'drawing' or 'result'

        // --- DOM å…ƒç´  ---
        const canvas = document.getElementById('drawing-board');
        const ctx = canvas.getContext('2d');
        const magicImg = document.getElementById('magic-result');
        
        // --- åˆå§‹åŒ– ---
        function init() {
            resizeCanvas();
            setWord('apple', false);

            window.addEventListener('resize', () => {
                clearTimeout(window.resizeTimer);
                window.resizeTimer = setTimeout(resizeCanvas, 100);
            });

            setupCanvasEvents();
        }

        // --- æ–°å•è¯åŠŸèƒ½ ---
        function openCustomModal() {
            document.getElementById('custom-word-modal').classList.remove('hidden');
            document.getElementById('new-word-input').value = "";
            document.getElementById('new-word-input').focus();
        }

        function closeCustomModal() {
            document.getElementById('custom-word-modal').classList.add('hidden');
        }

        async function confirmCustomWord() {
            const input = document.getElementById('new-word-input');
            const word = input.value.trim();
            if (!word) return;

            // ç®€å•æ ¡éªŒï¼šåªå…è®¸è‹±æ–‡å­—æ¯
            if (!/^[a-zA-Z\s-]+$/.test(word)) {
                alert("è¯·è¾“å…¥çº¯è‹±æ–‡å•è¯å“¦ï¼");
                return;
            }

            closeCustomModal();
            await generateNewWordCard(word);
        }

        // è°ƒç”¨ Netlify Function ç”Ÿæˆå•è¯å¡ä¿¡æ¯
        async function generateNewWordCard(word) {
            // UI çŠ¶æ€
            document.getElementById('word-loading').classList.remove('hidden');

            // ä¸´æ—¶æ·»åŠ ä¸€ä¸ªå ä½ç¬¦
            const newKey = 'custom_' + Date.now();

            try {
                // è°ƒç”¨ Netlify Function è¿›è¡Œç¿»è¯‘
                const response = await fetch('/.netlify/functions/translate-word', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ word: word })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `ç¿»è¯‘å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();

                // æ„é€ æ–°å•è¯æ•°æ®
                const colorPalette = ["#ec4899", "#8b5cf6", "#10b981", "#f59e0b"];
                const randomColor = colorPalette[Math.floor(Math.random() * colorPalette.length)];

                words[newKey] = {
                    text: word.charAt(0).toUpperCase() + word.slice(1),
                    meaning: `${data.translation} (${data.pinyin})`,
                    speak: `${word}, ${data.translation}`,
                    color: randomColor,
                    textCol: `text-[${randomColor}]`
                };

                // æ›´æ–° UI
                addWordButtonToUI(newKey, words[newKey]);
                setWord(newKey, true); // é€‰ä¸­å¹¶æœ—è¯»

            } catch (error) {
                console.error("Word Gen Error:", error);
                alert("ç”Ÿæˆå•è¯å¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚\n" + error.message);
            } finally {
                document.getElementById('word-loading').classList.add('hidden');
            }
        }

        function addWordButtonToUI(key, data) {
            const container = document.getElementById('word-selector');
            const btn = document.createElement('button');
            // æ’å…¥åˆ°å€’æ•°ç¬¬äºŒä¸ªä½ç½®ï¼ˆè‡ªå®šä¹‰æŒ‰é’®ä¹‹å‰ï¼‰
            const customBtn = document.getElementById('btn-custom-add');

            btn.id = `btn-${key}`;
            btn.className = `sketchy-btn py-2 sm:py-3 px-2 sm:px-4 bg-white text-slate-600 font-bold text-base sm:text-lg justify-start gap-2 sm:gap-3 transform transition-all hover:-rotate-1`;
            btn.onclick = () => setWord(key, true);
            btn.innerHTML = `<span class="text-xl sm:text-2xl">âœ¨</span> <span class="hidden sm:inline">${data.text}</span><span class="sm:hidden">âœ¨</span>`;

            container.insertBefore(btn, customBtn);
        }

        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            // ä»…åœ¨ç»˜ç”»æ¨¡å¼ä¸‹è°ƒæ•´å¤§å°å’Œä¿ç•™å†…å®¹
            if (appMode === 'drawing') {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(canvas, 0, 0);

                canvas.width = rect.width;
                canvas.height = rect.height;
                ctx.drawImage(tempCanvas, 0, 0);
                updateContextStyles();
            } else {
                // ç»“æœæ¨¡å¼ä¸‹åªéœ€è°ƒæ•´canvaså°ºå¯¸ä»¥é˜²ä¸‡ä¸€ï¼Œå†…å®¹ç”±imgæ ‡ç­¾è´Ÿè´£è‡ªé€‚åº”
                canvas.width = rect.width;
                canvas.height = rect.height;
            }
        }

        function updateContextStyles() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            if (isEraser) {
                ctx.lineWidth = brushSize * 4; 
                ctx.globalCompositeOperation = 'destination-out';
                canvas.classList.remove('cursor-pencil');
                canvas.classList.add('cursor-eraser');
            } else {
                ctx.lineWidth = brushSize;
                ctx.strokeStyle = brushColor;
                ctx.globalCompositeOperation = 'source-over';
                canvas.classList.add('cursor-pencil');
                canvas.classList.remove('cursor-eraser');
            }
        }

        function setWord(key, shouldSpeak = true) {
            // å¦‚æœå½“å‰æœ‰ç»“æœï¼Œå…ˆé‡ç½®
            if (appMode === 'result') {
                resetApp();
            }

            currentWordKey = key;
            const data = words[key];

            // æ›´æ–°æ˜¾ç¤ºæ–‡å­—å’Œå«ä¹‰
            const displayWord = document.getElementById('display-word');
            displayWord.innerText = data.text;

            // ç®€å•å¤„ç†é¢œè‰²
            if(data.textCol.startsWith('text-')) {
                displayWord.className = `text-2xl sm:text-3xl lg:text-4xl font-bold tracking-wide ${data.textCol} break-words max-w-[70%]`;
                displayWord.style.color = "";
            } else {
                displayWord.className = `text-2xl sm:text-3xl lg:text-4xl font-bold tracking-wide break-words max-w-[70%]`;
                displayWord.style.color = data.color;
            }

            document.getElementById('display-meaning').innerText = data.meaning;

            // --- åŠ¨æ€è®¾ç½®ä¸´æ‘¹å­—ä½“å¤§å° ---
            const traceText = document.getElementById('trace-letters');
            traceText.innerText = data.text.toLowerCase();

            const len = data.text.length;
            // æ ¹æ®é•¿åº¦åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
            if (len <= 4) {
                traceText.style.fontSize = "min(18vw, 220px)";
            } else if (len <= 7) {
                traceText.style.fontSize = "min(14vw, 160px)";
            } else if (len <= 10) {
                traceText.style.fontSize = "min(10vw, 120px)";
            } else {
                traceText.style.fontSize = "min(7vw, 90px)";
            }
            // ---------------------------------

            // æ›´æ–°æŒ‰é’®çŠ¶æ€ - æ”¯æŒåŠ¨æ€æ·»åŠ çš„æŒ‰é’®
            const allBtns = document.getElementById('word-selector').querySelectorAll('button');
            allBtns.forEach(b => {
                if(b.id !== 'btn-custom-add') {
                    b.style.transform = "";
                    b.classList.remove('ring-2', 'ring-slate-400', 'bg-violet-50');
                }
            });

            const activeBtn = document.getElementById(`btn-${key}`);
            if(activeBtn) {
                activeBtn.classList.add('ring-2', 'ring-offset-2', 'ring-slate-400', 'bg-violet-50');
                activeBtn.style.transform = "scale(1.05) translateX(5px)";
            }

            clearCanvas();

            if (shouldSpeak) {
                speakText(data.speak);
            }
        }

        function speakCurrentWord() {
            speakText(words[currentWordKey].speak);
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN'; 
            utterance.rate = 0.8;
            utterance.pitch = 1.2;
            window.speechSynthesis.speak(utterance);
        }

        // --- ç»˜ç”»é€»è¾‘ ---
        // æ£€æµ‹æ˜¯å¦åœ¨å®‰å…¨åŒºï¼ˆè¾¹ç¼˜æ»šåŠ¨åŒºåŸŸï¼‰
        function isInSafeZone(pos) {
            const safeMargin = 40; // å®‰å…¨åŒºå®½åº¦ï¼ˆåƒç´ ï¼‰
            const rect = canvas.getBoundingClientRect();

            // æ¡Œé¢ç«¯ä¸å¯ç”¨å®‰å…¨åŒº
            if (window.innerWidth >= 1024) return false;

            return pos.x < safeMargin ||
                   pos.x > rect.width - safeMargin ||
                   pos.y < safeMargin ||
                   pos.y > rect.height - safeMargin;
        }

        function setupCanvasEvents() {
            const start = (e) => {
                if (appMode !== 'drawing') return;
                const pos = getPos(e);

                // å¦‚æœåœ¨å®‰å…¨åŒºï¼Œä¸å¼€å§‹ç»˜ç”»
                if (isInSafeZone(pos)) return;

                isDrawing = true;
                updateContextStyles();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                if (!isEraser) ctx.lineWidth = brushSize * (0.8 + Math.random() * 0.4);
            };

            const move = (e) => {
                if (!isDrawing) return;
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                if (!isEraser) ctx.lineWidth = brushSize * (0.8 + Math.random() * 0.4);
            };

            const end = () => { isDrawing = false; if (isDrawing) ctx.closePath(); };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('mouseout', end);

            // è§¦æ‘¸äº‹ä»¶ï¼šå®‰å…¨åŒºå†…å…è®¸æ»šåŠ¨ï¼Œå…¶ä»–åŒºåŸŸç»˜ç”»
            canvas.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                const pos = getPos(touch);

                // å¦‚æœåœ¨å®‰å…¨åŒºï¼Œå…è®¸æ»šåŠ¨ï¼ˆä¸preventDefaultï¼‰
                if (isInSafeZone(pos)) {
                    return;
                }

                // å¦åˆ™é˜»æ­¢æ»šåŠ¨ï¼Œå¼€å§‹ç»˜ç”»
                e.preventDefault();
                start(touch);
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                // å¦‚æœæ­£åœ¨ç»˜ç”»ï¼Œé˜»æ­¢æ»šåŠ¨
                if (isDrawing) {
                    e.preventDefault();
                    move(e.touches[0]);
                }
            }, { passive: false });

            canvas.addEventListener('touchend', (e) => {
                if (isDrawing) {
                    e.preventDefault();
                }
                end();
            }, { passive: false });
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function setColor(color) {
            if (appMode !== 'drawing') return;
            isEraser = false;
            brushColor = color;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === 'btn-eraser') btn.classList.remove('bg-slate-200', 'ring-2', 'ring-slate-400');
            });
            const btns = document.querySelectorAll('.tool-btn');
            btns.forEach(b => { if(b.getAttribute('onclick') && b.getAttribute('onclick').includes(color)) b.classList.add('active'); });
            updateContextStyles();
        }

        function setEraser() {
            if (appMode !== 'drawing') return;
            isEraser = true;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            const eraserBtn = document.getElementById('btn-eraser');
            eraserBtn.classList.add('active', 'bg-slate-200');
            updateContextStyles();
        }

        function clearCanvas() {
            if (appMode !== 'drawing') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- é­”æ³•ç”Ÿæˆ ---
        async function generateMagic() {
            const btn = document.getElementById('btn-generate-magic');
            const loadingOverlay = document.getElementById('loading-overlay');
            const praiseModal = document.getElementById('praise-modal');
            const wordSelector = document.getElementById('word-selector');
            
            // 1. é”å®šç•Œé¢
            btn.disabled = true;
            btn.innerHTML = `ğŸ”® æ­£åœ¨æ–½æ³•ä¸­...`;
            loadingOverlay.classList.remove('hidden');
            wordSelector.classList.add('pointer-events-none', 'opacity-50'); // ç¦æ­¢åˆ‡æ¢å•è¯
            
            // 2. å‡†å¤‡ç”»å¸ƒæ•°æ®
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.fillStyle = "#ffffff";
            tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tCtx.drawImage(canvas, 0, 0);
            const base64Image = tempCanvas.toDataURL("image/png").split(',')[1];

            try {
                const wordText = words[currentWordKey].text;
                const prompt = `Act as a professional illustrator collaborating with a child.
                Task: Create a beautiful colored pencil illustration based on this child's drawing of a "${wordText}".

                CRITICAL RULES:
                1. KEEP THE CHILD'S ORIGINAL LINES EXACTLY AS THEY ARE. Do not reshape, hide, or "fix" the original strokes.
                2. Apply colors GENTLY inside the shapes defined by the child's lines.
                3. Build a magical, artistic background and atmosphere AROUND the drawing to make the composition look professional and harmonious.
                4. The final image MUST clearly depict the meaning of the word ("${wordText}") as the main subject.

                Style: Soft, warm colored pencils on paper. Naive charm mixed with professional artistic context.`;

                // è°ƒç”¨Netlify Functionè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨Google API
                const response = await fetch('/.netlify/functions/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        imageData: base64Image
                    })
                });

                if (!response.ok) {
                    // æ ¹æ®çŠ¶æ€ç æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    const errorData = await response.json().catch(() => ({}));
                    let errorMessage = "è¿æ¥å¤±è´¥";

                    if (response.status === 429) {
                        errorMessage = "AI ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™\nè¯·ç¨åå†è¯•æˆ–è”ç³»ç®¡ç†å‘˜";
                    } else if (response.status === 500) {
                        errorMessage = "æœåŠ¡å™¨é”™è¯¯\n" + (errorData.error || "è¯·æ£€æŸ¥é…ç½®");
                    } else if (response.status === 400) {
                        errorMessage = "è¯·æ±‚å‚æ•°é”™è¯¯";
                    }

                    throw new Error(errorMessage);
                }

                const result = await response.json();
                const imagePart = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData);

                if (imagePart) {
                     const finalImageBase64 = imagePart.inlineData.data;
                     magicImg.src = `data:image/png;base64,${finalImageBase64}`;

                     magicImg.onload = () => {
                        // --- æˆåŠŸæµç¨‹ ---
                        appMode = 'result';

                        // 1. éšè— Loading
                        loadingOverlay.classList.add('hidden');

                        // 2. æ˜¾ç¤ºç»“æœè¦†ç›–å±‚
                        magicImg.classList.remove('hidden');
                        canvas.classList.add('hidden');
                        document.getElementById('trace-layer').classList.add('hidden');
                        document.getElementById('canvas-bg').classList.add('hidden');

                        // 3. å¼¹å‡ºå¤¸å¥– + è¯­éŸ³
                        praiseModal.classList.remove('hidden');
                        speakText("å°æœ‹å‹ä½ çœŸæ£’ï¼ç”»å¾—å¤ªå¥½äº†ï¼");

                        // 4. åˆ‡æ¢å·¦ä¾§æŒ‰é’®
                        btn.classList.add('hidden');
                        document.getElementById('result-buttons').classList.remove('hidden');
                        document.getElementById('tools-panel').classList.add('opacity-20', 'pointer-events-none'); // ç¦ç”¨å·¥å…·æ 
                        document.getElementById('praise-text').classList.remove('hidden');

                        // 5. å‡ ç§’åéšè—å¤¸å¥–å¼¹çª—(ä¸éšè—ç»“æœ)
                        setTimeout(() => {
                            praiseModal.classList.add('hidden');
                        }, 3000);
                     };
                } else {
                    throw new Error('ç”Ÿæˆå¤±è´¥ï¼šæœªæ”¶åˆ°å›¾ç‰‡æ•°æ®');
                }
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                alert("å“å‘€ï¼Œé­”æ³•æš‚æ—¶å¤±çµäº†ï¼\n\n" + error.message + "\n\nè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚");
                loadingOverlay.classList.add('hidden');
                btn.disabled = false;
                btn.innerHTML = `âœ¨ æ–½å±•é­”æ³•`;
                wordSelector.classList.remove('pointer-events-none', 'opacity-50');
            }
        }

        function resetApp() {
            appMode = 'drawing';
            
            // æ¢å¤ç”»å¸ƒæ˜¾ç¤º
            magicImg.classList.add('hidden');
            canvas.classList.remove('hidden');
            document.getElementById('trace-layer').classList.remove('hidden');
            document.getElementById('canvas-bg').classList.remove('hidden');
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const btn = document.getElementById('btn-generate-magic');
            btn.disabled = false;
            btn.innerHTML = `âœ¨ æ–½å±•é­”æ³•`;
            btn.classList.remove('hidden');
            
            document.getElementById('result-buttons').classList.add('hidden');
            document.getElementById('word-selector').classList.remove('pointer-events-none', 'opacity-50');
            document.getElementById('tools-panel').classList.remove('opacity-20', 'pointer-events-none');
            document.getElementById('praise-text').classList.add('hidden');
            
            // éšè—å¤¸å¥–å¼¹çª—ï¼ˆä»¥é˜²ä¸‡ä¸€è¿˜åœ¨ï¼‰
            document.getElementById('praise-modal').classList.add('hidden');
        }

        function saveImage() {
            if (!magicImg.src) return;
            const link = document.createElement('a');
            link.download = `magic-${currentWordKey}.png`;
            link.href = magicImg.src;
            link.click();
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>